---
title: å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜
tags:
  - webpack
  - vite
categories:
  - å‰ç«¯
author: ä½™è…¾é–
pubDatetime: 2024-03-22
modDatetime: 2024-03-28
---

ç”±äºæœ€è¿‘é¢è¯•ç»å¸¸è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜ï¼ˆç®€å†ä¸Šå†™äº†ï¼‰ï¼Œæ„Ÿè§‰ç­”çš„æ—¶å€™ä¸æ˜¯å¾ˆç³»ç»Ÿæ¸…æ™°ï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚

## ä¸ºå•¥å¯¹è¿™ä¸ªé—®é¢˜è¿™ä¹ˆä¸Šå¿ƒï¼Ÿ

åœ¨ä¸Šå®¶å…¬å¸æœ€åä¸€æ®µæ—¶é—´æ˜¯åšå‰ç«¯å·¥ç¨‹åŸºå»ºç›¸å…³çš„ï¼Œä¸è¯´æ˜¯æœ€æœ‰æˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼Œä½†ç»å¯¹æ˜¯æœ€å¼€å¿ƒçš„ä¸€æ®µæ—¶é—´ã€‚ä¸Šæ¥ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ä¼˜åŒ–é¡¹ç›®æ„å»ºä½“ç§¯ï¼Œé¡¹ç›®ä¹‹å‰æ˜¯ **webpack** å†™çš„ï¼ŒåšæŠ€æœ¯å‡çº§ä¹‹åè¿ç§»åˆ°äº† **vite**ï¼ŒåŒ…ç®¡ç†å™¨ä¹Ÿä» **yarn1** è¿ç§»åˆ° **pnpm**ï¼Œä½†æ˜¯è¿ç§»åå‘ç°ä¸»å…¥å£ bundle çš„ä½“ç§¯å¢åŠ äº†å¾ˆå¤šï¼Œåé¢ä¹Ÿæ˜¯é‡‡ç”¨äº†å¤šä¸ªæ–¹æ³•å¯¹ä½“ç§¯è¿›è¡Œä¼˜åŒ–ï¼š

- å»é™¤é‡å¤ä¾èµ–ï¼Œæœ‰å¾ˆå¤šä¾èµ–ç”±äºå¼•ç”¨åˆ°äº†ä¸åŒç‰ˆæœ¬è¢«æ‰“åŒ…äº†å¤šæ¬¡ï¼Œå…·ä½“å“ªäº›åŒ…å¿˜äº†ï¼Œä½†æ˜¯å°è±¡ä¸­ `pnpm.overrides` å¾ˆé•¿
- æŒ‰éœ€å¯¼å…¥ï¼Œç»„ä»¶åº“æ˜¯ `ant design vue` basedï¼Œæˆ‘çŸ¥é“æœ€æ–°ç‰ˆå·²ç»æ”¯æŒ tree-shakingï¼Œä¸éœ€è¦é…ç½®æŒ‰éœ€å¯¼å…¥ï¼Œä½†å½“æ—¶é¡¹ç›®ç”¨çš„ç‰ˆæœ¬å¾ˆä½äº†ï¼Œæ¯•ç«Ÿè¿˜æ˜¯ vue2ã€‚
- é€‰æ‹©ç²¾ç®€çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚æˆ‘ä»¬é¡¹ç›®ç›®åªç”¨åˆ°äº† `paper.js` çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†æ˜¯é»˜è®¤ `paper` åŒ… `main` æ˜¯æŒ‡å‘ `dist/paper-full.js(451KB)` ä½ å¯ä»¥é…ç½®å®ƒæŒ‡å‘ `dist/paper-core.js(394KB)`ï¼Œ
- ä½¿ç”¨ `importmap` å°†åŒ…ä»æ„å»ºä¸­åˆ†ç¦»ï¼Œæ”¹ä¸ºä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ ESM ä» CDN åŠ è½½
- å¯¹äºä¸€äº›è¿˜åœ¨ä½¿ç”¨ `rollup` + `babel` æ‰“åŒ…çš„ package ä½¿ç”¨ `babel-runtime` é¿å…é‡å¤æ‰“åŒ… helper ä»£ç 
- ç²¾å‡†é…ç½® `browserslist`ï¼Œæ‰€æœ‰æ„å»ºå·¥å…·ç»Ÿä¸€ä½¿ç”¨ `package.json` ä¸­ `browserslist` å­—æ®µè¯»å–æµè§ˆå™¨å…¼å®¹ç›®æ ‡ç‰ˆæœ¬
- é¡¹ç›®ä¸­åŒæ—¶ä½¿ç”¨äº†å¤šä¸ªåŠŸèƒ½ç±»å‹çš„ pkgï¼Œä¾‹å¦‚æ—¶é—´ç›¸å…³çš„ `moment`, `dayjs`, `date-fns`, è¿˜æœ‰æˆ‘è®°å¾—ç”ŸæˆäºŒç»´ç å’Œå¤„ç† `xlsx` çš„åº“ä¹Ÿæœ‰å¤šä¸ªï¼Œä¸ºäº†è¿™ä¸ªé—®é¢˜æˆ‘è¿˜å†™äº†ä¸ª cli: [find-similar-packages](https://github.com/tjx666/find-similar-packages)
- é€šçŸ¥å…¶å®ƒéƒ¨é—¨åŒäº‹ä¸è¦æŠŠ `node_modules` æ‰“åŒ…åˆ° `dist` é‡Œé¢ï¼ŒæŠŠ `ant design vue` çš„ `babel-runtime` å‡çº§åˆ° `@babel/runtime`ï¼Œåæ­£å°±æ˜¯è¯´æœ‰äº›åŒ…æ‰“åŒ…å¾ˆä¸è§„èŒƒ
- ...

ç­‰ç­‰ï¼Œç¦»èŒæ··æ—¥å­å¿«åŠå¹´äº†ï¼Œæš‚æ—¶åªèƒ½æƒ³èµ·è¿™äº›ã€‚

å›åˆ°ä¸»é¢˜ï¼Œåœ¨æˆ‘æ‰€æœ‰çš„ä¼˜åŒ–ç­–ç•¥ä¸­ï¼Œå»é™¤é‡å¤ä¾èµ–å‡å°æ‰“åŒ…ä½“ç§¯çš„æ•ˆæœæ˜¯å ç¬¬äºŒä½çš„ã€‚ç¬¬ä¸€ä½æ˜¯ `importmap`ï¼Œæœ€ç®€å•çš„å‡å°ä½“ç§¯ç­–ç•¥å°±æ˜¯ä¸æ‰“åŒ…ã€‚å…³äº `importmap`ï¼Œæœ‰æœºä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« ã€‚

## é‡å¤ä¾èµ–æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ

åœ¨è®¨è®ºä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€äº›åé¢ä¼šæåˆ°çš„æœ¯è¯­ï¼Œç¡®ä¿æˆ‘ä»¬åœ¨åŒä¸€ä¸ªé¢‘é“ä¸Šã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹çš„ monorepo å‰ç«¯é¡¹ç›®ï¼š

```plaintext
./mono
â”œâ”€â”€ apps // åº”ç”¨çº§åˆ«çš„åŒ…
â”‚   â”œâ”€â”€ mobile
â”‚   â””â”€â”€ web
â”œâ”€â”€ packages // å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ pkg1
â”‚   â”œâ”€â”€ pkg2
â”‚   â”œâ”€â”€ ui
â”‚   â””â”€â”€ utils
â””â”€â”€ tools // å·¥å…·åŒ…
    â”œâ”€â”€ eslint-config
    â””â”€â”€ vite-config
```

`apps`, `packages`, `tools` éƒ½å« `workspace`, é‡Œé¢ package ç§°ä¹‹ä¸º `workspace package`ï¼Œ`mono` æ–‡ä»¶å¤¹å« `root workspace`ã€‚

åœ¨åŒ…ç®¡ç†å™¨çš„è§†è§’ä¾èµ–å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

- **ç›´æ¥ä¾èµ–**ï¼šä¾‹å¦‚ workspace package `ui` çš„ `package.json` ä¸­å£°æ˜çš„ `axios`
- **é—´æ¥ä¾èµ–**ï¼šä¾‹å¦‚ `axios` ä¾èµ–çš„ `follow-redirects`

æŒ‰ç…§ç”¨é€”åˆ†ä¸ºä¸¤ç±»ï¼š

- **æºç ä¾èµ–**ï¼šä¾‹å¦‚ `apps/web/src` å¯¼å…¥äº† `pkg1` å’Œ `vue`ï¼Œ`pkg1` å’Œ `vue` ä»¥åŠå®ƒä¿©ä¾èµ–æ ‘ä¸Šçš„ä¾èµ–ç§°ä¸ºæºç ä¾èµ–
- **å¼€å‘ä¾èµ–**ï¼šä¾‹å¦‚ `vite`, `esbuild` ä¸ä¼šè¢«æ‰“åŒ…åˆ° `apps/web/dist` ä¸­çš„åªåœ¨å¼€å‘æ—¶ä½¿ç”¨çš„ä¾èµ–ï¼Œä¹ŸåŒ…æ‹¬å®ƒä¿©ä¾èµ–æ ‘ä¸Šçš„ä¾èµ–

### lockfile çš„å‰¯ä½œç”¨

lockfile å¯ä»¥å¸®æˆ‘ä»¬ç¡®ä¿å®‰è£…çš„ä¾èµ–å®Œå…¨ä¸€è‡´ï¼Œä½†æ˜¯å®ƒå´ä¹Ÿæ˜¯å¯¼è‡´æˆ‘ä»¬é¡¹ç›®ä¾èµ–å®‰è£…å¤šä¸ªç‰ˆæœ¬çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚

åœºæ™¯è¿˜åŸï¼š

1. æˆ‘ä»¬åœ¨ `pkg1` ä¸­çš„ `dependencies` å£°æ˜ `"foo": "^1.0.1"â€`ï¼Œæ­¤æ—¶ `foo` æœ€æ–°ç‰ˆæœ¬æ˜¯ `1.0.1`ï¼Œè¿è¡Œ `pnpm install`, è¿™æ—¶ lockfile ä¸­å†™å…¥äº† `pkg1` çš„ `foo` è§£æåˆ°çš„ç‰ˆæœ¬æ˜¯ `1.0.1`ï¼Œå®é™…ä¹Ÿæ˜¯å®‰è£… `1.0.1`
2. æŸä¸€å¤©æˆ‘ä»¬éœ€è¦åœ¨ `pkg2` ä¸­å¼€å‘éœ€æ±‚ï¼Œ`pkg2` ä¹Ÿè¦ç”¨åˆ° `foo`ï¼Œäºæ˜¯è¿è¡Œ `pnpm --filter pkg2 add foo`ï¼Œåœ¨è¿™æ®µæ—¶é—´ `foo` å‘å¸ƒäº† `1.0.2`ï¼Œæ­¤æ—¶ `pkg2` å®‰è£…çš„å°±ä¼šæ˜¯ `1.0.2`ã€‚æˆ‘ä»¬çš„ app package ä¾èµ– `pkg1` å’Œ `pkg2`ï¼Œäºæ˜¯æ‰“åŒ… app çš„æ—¶å€™å°±ä¼šæ‰“åŒ… `foo@1.0.1` å’Œ `foo@1.0.2`

ä½ å¯èƒ½ä¼šè¯´ pnpm å’‹è¿™ä¹ˆè ¢ï¼Œä¸ä¼šç›´æ¥æŠŠ `pkg1` çš„ `foo` ä¹Ÿå®‰è£…ä¸º `1.0.2` å—ï¼Œ`1.0.2` æ˜¯ç¬¦åˆ `^1.0.1` çš„å…¼å®¹æ€§è¦æ±‚çš„å‘€ã€‚å®é™…ä¸ŠæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œpnpm ä¹‹æ‰€ä»¥æ²¡è¿™ä¹ˆåšï¼Œæ˜¯å› ä¸º

1. lockfile é‡Œé¢å·²ç»å£°æ˜äº† `pkg1` çš„ `foo` è§£æåˆ°çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¼šç›´æ¥æŒ‰ç…§ lockfile å£°æ˜çš„ç‰ˆæœ¬æ¥
2. å› ä¸º pkg ä¸­ `foo@1.0.1` ä¹‹å‰å·²ç»éªŒè¯æµ‹è¯•æ—¶å¯ç”¨çš„ï¼Œè¦æ˜¯å®ƒå¸®ä½ æ›´æ–°åˆ° `1.0.2` å¯èƒ½ä¼šå‡ºç° bugï¼Œä¸ºäº†ç¡®ä¿é¡¹ç›®çš„ç¨³å®šé»˜è®¤ä¸ä¼šå¸®ä½ å‡çº§ã€‚semver åªæ˜¯ä¸€ä¸ªè§„èŒƒï¼Œ `1.0.1` åˆ° `1.0.2` åˆ°åº•æœ‰æ²¡æœ‰å¼•æ²¡æœ‰å¼•å…¥ `breaking change` é‚£ä½ å¾—å»çœ‹ `changelog` å’Œæºä»£ç æ‰èƒ½ç¡®å®šã€‚

### ä¸å…¼å®¹ç‰ˆæœ¬

ä¸€ä¸ªå¾ˆå…¸å‹çš„ä¾‹å­å°±æ˜¯å»å¹´ `axios` å‘å¸ƒäº† `1.x`ï¼Œé¡¹ç›®ä¸­åŒæ—¶å­˜åœ¨ `0.x` å’Œ `1.x`ã€‚è‰ï¼Œ`axios` è¿™ä¹ˆå¤è€çš„é¡¹ç›®ç›´åˆ°å»å¹´æ‰å‘ `1.x` ä½ æ•¢ä¿¡ï¼Ÿ`esbuild` å’Œ `react native` åŠ æŠŠæ²¹ï¼Œå¸Œæœ›æˆ‘é€€ä¼‘ä¹‹å‰èƒ½å‘ `1.0`ã€‚

å³ä¾¿ä¾èµ–æ ‘ä¸Šçš„åŒ…åœ¨ `dependencies` ä¸­å£°æ˜ `axios` çš„æ—¶å€™éƒ½ä½¿ç”¨äº†å…¼å®¹æ€§å‰ç¼€ `^`ï¼Œä½†æ˜¯å¯¹äºè¿™ç§ä¸ç¬¦åˆå…¼å®¹æ€§å‰ç¼€çš„å¤šä¸ªç‰ˆæœ¬ï¼Œpnpm å°±æ²¡æ³•é€šè¿‡åæ–‡ä¼šè¯¦ç»†ä»‹ç»çš„`åˆ  lockfile é‡è£…`æˆ–è€…è·‘ `pnpm dedupe` æ¥è§£å†³äº†ã€‚

é™¤æ­¤ä¹‹å¤–è¿˜æœ‰æ¢åŒ…åè¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œä¾‹å¦‚ `babel-runtime` -> `@babel/runtime`

### peerDependencies

æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ `node_modules/.pnpm` é‡Œé¢å­˜æ”¾çš„æ˜¯ç¼“å­˜çš„ç¡¬é“¾æ¥ï¼Œå®ƒçš„å‘½åæ ¼å¼æ˜¯ `pkgName@pkgVersion_peer1Name@peer1Version_peer2Name@peer2Version`ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç”±æœ¬èº«çš„åŒ…åï¼Œç‰ˆæœ¬å·å’Œå®ƒçš„æ‰€æœ‰ peerDependencies åŒ…åï¼Œç‰ˆæœ¬å·ç»„æˆï¼Œä½¿ç”¨ `_` è¿æ¥ï¼Œåœ¨ `lockfile` ä¸­æ˜¯ç”¨æ‹¬å·ï¼Œä¾‹å¦‚ `react@16.8.0(typescript@8.0.0)`ã€‚

å®é™…çš„é¡¹ç›®ä¸­å°±å¯èƒ½åœ¨ `.pnpm` ä¸‹çœ‹åˆ°åŒä¸€ä¸ªåŒ…åå’Œç‰ˆæœ¬å·ï¼Œç”±äºå®é™…ä¾èµ–çš„ peerDependencies ä¸åŒå®‰è£…äº†å¤šæ¬¡ã€‚

```plaintext
# workspace package
# packages/pkg1/package.json
{
  "dependencies": {
    "vue": "2.6.14",
    "@yutengjing/foo": "1.0.3" // å¯¹åº”ç¡¬é“¾æ¥ @yutengjing+foo@1.0.3_vue@2.6.14
  }
}

# workspace package
# packages/pkg2/package.json
{
  "dependencies": {
    "vue": "2.7.16",
    "@yutengjing/foo": "1.0.3" // å¯¹åº”ç¡¬é“¾æ¥ @yutengjing+foo@1.0.3_vue@2.7.16
  }
}

# é—´æ¥ä¾èµ–
# @yutengjing/foo
{
  "peerDependencies": {
    "vue": "^2.7.16"
  }
}

node_modules
  .pnpm
    @yutengjing+foo@1.0.3_vue@2.6.14
      node_modules
        @yutengjing/foo@1.0.3
        vue@2.6.14
    @yutengjing+foo@1.0.3_vue@2.7.16
      node_modules
        @yutengjing/foo@1.0.3
        vue@2.7.16

```

ç”±äºæœ¬åœ°å®‰è£…çš„ peerDependencies vue çš„ç‰ˆæœ¬ä¸åŒï¼Œä¸”éƒ½ä¸ç¬¦åˆå…¼å®¹æ€§è¦æ±‚ `^2.7.16`ï¼Œå®é™…ä¸Šä¼šå­˜åœ¨ä¸¤ä¸ªç¡¬é“¾æ¥ä¾èµ– `@yutengjing+foo@1.0.3_vue@2.6.14` å’Œ `@yutengjing+foo@1.0.3_vue@2.7.16`ã€‚

è™½ç„¶éƒ½æ˜¯ `@yutengjing+foo@1.0.3`, ä½†æ˜¯ç”±äºæ˜¯ä¸åŒçš„ç¡¬é“¾æ¥ï¼Œè¢«è§†ä¸ºä¸åŒçš„æ–‡ä»¶ï¼Œå°±ä¼šæ‰“åŒ…å¤šæ¬¡ã€‚

![é‡å¤æ‰“åŒ…](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/peerDeps.png?raw=true)

å…³äº `peerDependencies` åœ¨ pnpm ä¸­æ˜¯æ€ä¹ˆè§£æçš„ï¼Œå¯ä»¥é˜…è¯»ï¼š[How peers are resolved](https://pnpm.io/how-peers-are-resolved)ã€‚

æ–‡ç« å†™åˆ°è¿™æˆ‘æ‰å‘ç°åé¢è¦ä»‹ç»çš„æˆ‘å†™çš„åˆ†æé‡å¤ä¾èµ–çš„æ’ä»¶æœ‰ bugï¼Œå› ä¸ºæˆ‘æ²¡è€ƒè™‘åŒä¸€ä¸ªä¾èµ–åŒä¸€ä¸ªç‰ˆæœ¬è¢«æ‰“åŒ…å¤šæ¬¡çš„æƒ…å†µï¼Œé©¬ä¸Šä¿®ï¼

é¡ºä¾¿æä¸€ä¸‹ä¸Šé¢ pkg1 å’Œ pkg2 ä¾èµ–çš„ vue å¦‚æœéƒ½ä½¿ç”¨å…¼å®¹æ€§å‰ç¼€ï¼ˆä¹Ÿå°±æ˜¯ `^2.6.14` å’Œ `^2.7.16`ï¼‰ï¼Œpnpm æœ€æ–°ç‰ˆæ˜¯å¯ä»¥è‡ªåŠ¨å»é‡çš„ï¼Œç¡¬é“¾æ¥åˆ° `node_modules/.pnpm` ä¸‹çš„ `@yutengjing+foo@1.0.3_vue@2.7.16`ã€‚

### å…¶å®ƒæƒ…å†µ

ä¹‹å‰æœ‰å‘ç°æŸäº›é‡å¤ä¾èµ–æ€»æ˜¯å¹²ä¸æ‰ï¼Œä»”ç»†æŸ¥çœ‹ä¾èµ–è·¯å¾„å‘ç°æœ‰ä¸ªåˆ«ä¸è§„èŒƒçš„ package æ„å»ºçš„æ—¶å€™æŠŠ dependencies ä¹Ÿæ‰“åŒ…åˆ° `dist` äº†ã€‚

## å¦‚ä½•å‘ç°é‡å¤ä¾èµ–ï¼Ÿ

ä¸‹é¢ä»‹ç»ä¸‹æˆ‘ä½¿ç”¨è¿‡çš„æ–¹æ³•å’Œå·¥å…·ã€‚

### ç›´æ¥çœ‹ä¾èµ–åˆ†å¸ƒå›¾

å¯¹äºä¸€ä¸ªåœ¨ 3 å¹´å‰åº”å±Šæ—¶æœŸå°±æ˜¯ `webpack` è€é¸Ÿçš„æˆ‘ï¼Œç¬¬ä¸€æ­¥å½“ç„¶æ˜¯è£…ä¸Šä¸€äº›æ„å»ºåˆ†æå·¥å…·æ¥çœ‹çœ‹é¡¹ç›®é‡Œé¢æ‰“åŒ…äº†å“ªäº›å¦–é­”é¬¼æ€ªã€‚äºæ˜¯æ‰¾ä¸‹ `vite` çš„ bundle å¯è§†åŒ–å·¥å…·ï¼Œæ²¡æ‰¾åˆ°ï¼Œäºæ˜¯æœäº†æœ `rollup` ç›¸å…³çš„æ’ä»¶ï¼Œè¢«æˆ‘æ‰¾åˆ° [rollup-plugin-visualizer](https://github.com/btd/rollup-plugin-visualizer)ã€‚è¦å’±è¯´ä¸ºä»€ä¹ˆ `vite` èƒ½è¿™ä¹ˆæˆåŠŸï¼Œå…¼å®¹ `rollup` æ’ä»¶å¾ˆå…³é”®å•Šã€‚å½“æ—¶æˆ‘å¯¹ `vite` å…¶å®ä¸€ç‚¹éƒ½ä¸ç†Ÿï¼Œä¹Ÿæ²¡é‚£ä¹ˆå¤š `vite` æ’ä»¶ï¼Œå¾ˆå¤šæ’ä»¶éƒ½æ˜¯ç”¨ `rollup` çš„ï¼Œå°±éå¸¸ä½©æœ `vite` å…¼å®¹ `rollup` æ’ä»¶çš„è¿™ä¸ªè®¾è®¡ã€‚è¦é—® `rspack` å’Œ `turbopack` æ›´çœ‹å¥½è°ï¼Ÿé‚£è‚¯å®šæ˜¯ `rspack`ã€‚`rspack` å…¼å®¹ `webpack` ç”Ÿæ€å‘€ï¼Œçœ‹çœ‹ `bun` å’Œ `deno` ç°åœ¨çš„æµè¡Œè¶‹åŠ¿è¿˜ä¸å¤Ÿè¯´æ˜é—®é¢˜å—ï¼Ÿ

æˆ‘è®°å¾—æˆ‘å½“æ—¶åˆ†ææˆ‘ä»¬å…¬å¸é‚£ä¸ªé¡¹ç›®çš„æ—¶å€™å½“æ—¶å°±å‘ç°æ‰“åŒ…äº†å¥½å‡ ä¸ª `ant design vue`ï¼Œå¯¹äºé‚£äº›ä½“ç§¯è¾ƒå¤§çš„ä¾èµ–ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥ã€‚ç„¶åå¯ä»¥è¯•ç€è¿‡æ»¤ä¸€äº›éå¸¸å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œåƒ `vue`, `vue-router`, `lodash` è¿™äº›ã€‚

æ‹¿ github star 21k çš„ [vue-vben-admin](https://github.com/vbenjs/vue-vben-admin) åšæµ‹è¯•ï¼Œæœ¬æ¥æƒ³ç”¨ç½‘çº¢é¡¹ç›® [elk](https://github.com/elk-zone/elk) çš„ï¼Œä½†æ˜¯è¿™ä¸ªé¡¹ç›®æ„å»ºæœ‰ç‚¹å¤æ‚ï¼Œä¼šæ„å»ºå¥½å‡ æ¬¡ï¼Œæˆ‘å¯¹ `nuxt` ä¹Ÿä¸ç†Ÿï¼Œè¿˜æ˜¯ç®—äº†ã€‚

![bundle visualizer](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/bundle-visualizer.png?raw=true)

`rollup-plugin-visualizer` è¿™ä¸ªæ’ä»¶å»ºè®®ç”¨ 5.8.3 ç‰ˆæœ¬ï¼Œæœ€æ–°ç‰ˆè¿‡æ»¤ä¸å¤ªå¥½ç”¨ï¼Œå‚è€ƒ issueï¼š[new Include and Exclude is hard to understand and use](https://github.com/btd/rollup-plugin-visualizer/issues/149)

### åŸºäº lockfile åˆ†æçš„ cli

æ—©åœ¨ [pnpm dedupe](https://pnpm.io/cli/dedupe) å‡ºæ¥ä¹‹å‰ï¼Œæˆ‘ä¸€ç›´ç”¨çš„æ˜¯ [pnpm-deduplicate](https://github.com/ocavue/pnpm-deduplicate)ï¼Œæ•ˆæœå¾ˆç›´è§‚ï¼š

```bash
Package "@babel/runtime" wants ^7.17.10 and could get 7.18.2, but got 7.18.0
Package "@babel/runtime" wants ^7.15.5 and could get 7.18.2, but got 7.18.0
Package "@babel/runtime" wants ^7.7.5 and could get 7.18.2, but got 7.18.0
Package "@babel/generator" wants ^7.7.2 and could get 7.18.2, but got 7.18.0
Package "@babel/generator" wants ^7.18.0 and could get 7.18.2, but got 7.18.0
```

æ•´æŒºå¥½ï¼Œä½†æ˜¯å’Œ pnpm ä¸€æ ·åªè¦æ˜¯åŸºäº lockfile åˆ†æçš„å·¥å…·éƒ½æœ‰ä¸€ä¸ªé€šç—…ï¼Œå°±æ˜¯æ— æ³•åŒºåˆ†å¼€å‘ä¾èµ–å’Œæºç ä¾èµ–ã€‚å¦å¤–ï¼Œåœ¨å®é™…çš„ monorepo é¡¹ç›®ä¸­ï¼Œä½ å¯èƒ½å­˜åœ¨å¤šä¸ª app éœ€è¦æ„å»ºï¼Œå¯èƒ½ä¸åŒçš„ app ä¾èµ–äº†ä¸åŒç‰ˆæœ¬ä¹Ÿä¼šè¢«æ‰«æå‡ºæ¥ã€‚

æœ‰æ—¶å€™ä¸ºäº†ç¡®ä¿æŸä¸ªé‡å¤ä¾èµ–æ˜¯å¦è¢«å¹²æ‰ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥å» `pnpm-lock.yaml` é‡Œé¢æœç´¢é‚£ä¸ª packageï¼Œè¿˜å¯ä»¥å€ŸåŠ© [pnpm why](https://pnpm.io/cli/why) å»æŸ¥çœ‹ä¸€ä¸ªåŒ…æ˜¯å› ä¸ºä»€ä¹ˆåŸå› è¢«å®‰è£…çš„ã€‚

### æ‰“åŒ…å·¥å…·æ’ä»¶

æœ€å¼€å§‹æˆ‘æœåˆ°äº† [duplicate-package-checker-webpack-plugin](https://github.com/darrenscerri/duplicate-package-checker-webpack-plugin)ï¼Œä½†æ˜¯æˆ‘ä»¬é¡¹ç›®ç”¨çš„æ˜¯ `vite`ï¼Œäºæ˜¯ç†Ÿæ‚‰ `vite` æ’ä»¶å¼€å‘çš„æœºä¼šæ¥äº†ï¼Œå½“æ—¶ `unplugin` æŒºç«ï¼Œå¯ä»¥è®©ä½ ç”¨ `rollup` æ’ä»¶ç³»ç»Ÿçš„é’©å­å†™è·¨æ„å»ºå·¥å…·çš„æ’ä»¶ï¼Œäºæ˜¯åœ¨å€Ÿé‰´äº†å‰é¢æåˆ°çš„ `webpack` æ’ä»¶å’Œ `chatgpt` çš„å¸®åŠ©ä¸‹å¾ˆå¿«å°±å†™å‡ºäº† [unplugin-detect-duplicated-deps](https://github.com/tjx666/unplugin-detect-duplicated-deps)ã€‚

è¿˜æ˜¯æ‹¿é¡¹ç›® [vue-vben-admin](https://github.com/vbenjs/vue-vben-admin/tree/main) æ¥åšæµ‹è¯•ï¼Œå¦‚æœä½¿ç”¨ `pnpm dedupe`ï¼Œç»“æœæ˜¯ï¼š

![vben pnpm dedupe](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/vben-pnpm-dedupe.png?raw=true)

å¦‚æœä½¿ç”¨æˆ‘å†™çš„æ’ä»¶ï¼š

![vben unplugin](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/vben-unplugin.png?raw=true)

`vue-types` åœ¨ `pnpm dedupe` ä¸­æ£€æµ‹ä¸å‡ºæ¥å¥½ç†è§£ï¼Œå› ä¸ºæ˜¯è·¨å¤§ç‰ˆæœ¬å·ã€‚é‚£ `sortablejs` ä¸ºå•¥æ²¡æ£€æŸ¥å‡ºæ¥ï¼Ÿ `axios` æ€ä¹ˆåˆè¢«æ£€æŸ¥å‡ºæ¥äº†ï¼Ÿ

æˆ‘ä»¬å¯ä»¥å€ŸåŠ© `pnpm why` æ¥åˆ†æä¾èµ–æ˜¯æ€ä¹ˆè¢«å¼•å…¥é¡¹ç›®çš„ï¼š

```bash
â¯ pnpm why -r axios
Legend: production dependency, optional only, dev only

vben-admin@2.10.1 /Users/yutengjing/code/vue-vben-admin

dependencies:
axios 1.6.7

devDependencies:
unplugin-detect-duplicated-deps 1.1.1
â””â”€â”€ axios 1.6.8

@vben/vite-config@1.0.0 /Users/yutengjing/code/vue-vben-admin/internal/vite-config

devDependencies:
vite-plugin-purge-icons 0.10.0
â”œâ”€â”¬ @purge-icons/core 0.10.0
â”‚ â””â”€â”€ axios 0.26.1
â””â”€â”¬ rollup-plugin-purge-icons 0.10.0
  â””â”€â”¬ @purge-icons/core 0.10.0
    â””â”€â”€ axios 0.26.1
```

æŸ¥çœ‹å‘ç°ä¸€ä¸ªç‰ˆæœ¬æ˜¯æºç ä¾èµ– `/Users/yutengjing/code/vue-vben-admin/package.json` ä¾èµ–äº† `axios@1.6.7`ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯å¼€å‘ä¾èµ–ï¼š`unplugin-detect-duplicated-deps` ä¾èµ–äº† `axios@1.6.8`ï¼Œ`@purge-icons/core` ä¾èµ–äº† `axios@0.26.1`ã€‚

```bash
â¯ pnpm why sortablejs
vben-admin@2.10.1 /Users/yutengjing/code/vue-vben-admin

dependencies:
sortablejs 1.15.2
vuedraggable 4.1.0
â””â”€â”€ sortablejs 1.14.0
```

æ‰“å¼€ `vuedraggable` çš„ `package.json` çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°å±…ç„¶æ˜¯ä½¿ç”¨å›ºå®šç‰ˆæœ¬å·å£°æ˜çš„ `"sortablejs": "1.14.0"`ï¼Œæ€ªä¸å¾— `pnpm dedupe` æ£€æµ‹ä¸å‡ºæ¥ã€‚

#### åŸç†

é¢è¯•ç»å¸¸è¢«é—®åˆ° `webpack` æ’ä»¶æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå…¶å® `webpack` å’Œå…¶ä»–å®ƒå¾ˆå¤šæ„å»ºå·¥å…·çš„æ’ä»¶çš„å¼€å‘æ–¹å¼éƒ½ä¸€æ ·ï¼Œæ’ä»¶æœ¬è´¨ä¸Šå°±æ˜¯å»è®¢é˜…æ„å»ºå·¥å…·æš´éœ²çš„æ‰©å±•äº‹ä»¶ï¼ˆæˆ–è€…è¯´é’©å­ï¼‰ï¼Œåœ¨å›è°ƒç¼–å†™ä½ çš„æ‰©å±•é€»è¾‘ã€‚

æ ¸å¿ƒé€»è¾‘ï¼š

1. å†æ‰“åŒ…å·¥å…·**è§£æå®Œæ¨¡å— id** åè·å–å…¶å¯¹åº”çš„æ–‡ä»¶ç»å¯¹è·¯å¾„
2. ä»æ–‡ä»¶å½“å‰ç›®å½•å¾€ä¸Šæ‰¾ **package.json**ï¼Œç¡®å®šè¿™ä¸ªæ¨¡å—æ˜¯å“ªä¸ªåŒ…ï¼Œä»¥åŠå“ªä¸ªç‰ˆæœ¬å¼•å…¥çš„
3. åœ¨**æ„å»ºç»“æŸ**ååˆ†ææ”¶é›†åˆ°çš„æ¨¡å—ä¿¡æ¯ï¼Œå¯¹äºé‚£äº›åŒä¸€ä¸ªä¾èµ–å‡ºç°äº†å¤šä¸ªç‰ˆæœ¬ï¼Œåˆ™è¢«è§†ä¸ºæœ‰é—®é¢˜çš„ä¾èµ–
4. å½“æœ‰ä¾èµ–è¢«é‡å¤æ‰“åŒ…åˆ™è¾“å‡ºæœ‰é—®é¢˜çš„ä¾èµ–ä¿¡æ¯

ç¬¬ä¸€æ­¥å¯ä»¥ä½¿ç”¨ `rollup` çš„ `resolveId` äº‹ä»¶ï¼Œç¬¬ä¸‰æ­¥åˆ™å¯ä»¥ä½¿ç”¨ `buildEnd` äº‹ä»¶ã€‚

#### æ˜¾ç¤ºåŒ…çš„ä½“ç§¯

åªæ˜¯åˆ—å‡ºäº†è¢«é‡å¤æ‰“åŒ…çš„ä¾èµ–ï¼Œæ„Ÿè§‰å¯¹æ„å»ºä½“ç§¯çš„å½±å“ä¸å¤Ÿç›´è§‚ï¼Œäºæ˜¯ä¾¿å€ŸåŠ© <https://bundlephobia.com/> çš„ api æ¥è·å–ä¾èµ–çš„ä½“ç§¯å¹¶å±•ç¤ºï¼Œæ¥å£å¾ˆç®€å•ï¼š

```plaintext
https://bundlephobia.com/api/size?package=${name}@${version}
```

å…¶å®æˆ‘ä¸€ç›´ä¸å¤ªç†è§£ä¸ºå•¥ç”¨ [import cost](https://marketplace.visualstudio.com/items?itemName=wix.vscode-import-cost) vscode æ’ä»¶çš„äººé‚£ä¹ˆå¤šï¼Œè¿™ç©æ„å› ä¸ºè·å–ä¸€ä¸ªåŒ…ä½“ç§¯éœ€è¦è·‘ä¸€æ¬¡ `webpack`ï¼Œæ‰€ä»¥åˆæ…¢åˆåƒèµ„æºï¼Œç›´æ¥ç”¨ api è¯·æ±‚ä¸é¦™å—ï¼Ÿ

#### å¦‚ä½•é¢„é˜²å†æ¬¡å‡ºç°é‡å¤ä¾èµ–

æœ€åˆå€ŸåŠ©è¿™ä¸ªæ’ä»¶æŠŠä¸€äº›é‡å¤ä¾èµ–å¹²æ‰åï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œå‘ç°åˆå¤šäº†ä¸€äº›æ–°çš„é‡å¤ä¾èµ–ã€‚å¯¹äºå¼€å‘æ•ˆç‡æœ‰æè‡´è¿½æ±‚çš„æˆ‘ï¼Œå—ä¸äº†è‡ªå·±å†å¤„ç†ä¸€éï¼Œè°æ‹‰çš„ ğŸ’© åº”è¯¥è®©ä»–è‡ªå·±å»å¤„ç†ã€‚å½“æ—¶æœ‰åœ¨åš ci check çš„ä¼˜åŒ–ï¼Œäºæ˜¯è¯´èƒ½ä¸èƒ½æŠŠé‡å¤ä¾èµ–æ£€æŸ¥åŠ åˆ° ci ä¸Šå»ã€‚è¿™æ˜¯æˆ‘åœ¨ä¸Šå®¶å…¬å¸è´¡çŒ®çš„æœ€åä¸€ä¸ª pr äº†ï¼Œä¹Ÿæ˜¯æŠ€æœ¯åˆ†äº«ä¼šæœ€ååˆ†äº«çš„å†…å®¹äº† ğŸ˜‚ã€‚äºæ˜¯è¿™ä¸ªæ’ä»¶æ–°å¢äº†ä¸€ä¸ªé€‰é¡¹ `throwErrorWhenDuplicated`ï¼Œå½“è®¾ç½®ä¸º true æ—¶ï¼Œå‡ºç°é‡å¤ä¾èµ–çš„æ—¶å€™æ„å»ºè¿›ç¨‹ä¾¿ä¼šé€€å‡ºã€‚è¿™ä¸ªæ—¶å€™ä½ å¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š

1. é€šè¿‡æ’æŸ¥å‡ºç°é‡å¤ä¾èµ–çš„åŸå› ï¼Œæ¶ˆé™¤æ‰è¿™ä¸ªé‡å¤ä¾èµ–
2. é€šè¿‡ `ignore` é€‰é¡¹é…ç½®ç™½åå•

```typescript
export default defineConfig({
  plugins: [
    UnpluginDetectDuplicatedDeps({
      throwErrorWhenDuplicated: true,
      ignore: {
        axios: ['0.27.2'],
        vue: ['*'],
      },
    }),
  ],
});
```

![ci checker](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/checker.png?raw=true)

## å¦‚ä½•ä¿®å¤é‡å¤ä¾èµ–ï¼Ÿ

### å¯¹ package æ‰“åŒ…æ—¶ä¸è¦æ‰“åŒ… dependencies

è¿™ä¸ªæ¨èä½¿ç”¨æˆ‘ç»´æŠ¤çš„æ’ä»¶ [unplugin-externalize-deps](https://github.com/tjx666/unplugin-externalize-deps)ã€‚å¦‚æœä½ æŠŠ dependencies ä¹Ÿæ‰“åŒ…åˆ° dist é‡Œé¢äº†ï¼Œtree-shaking ä¹Ÿæ•‘ä¸äº†ä½ å•Šã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œpkg1 å’Œ pkg2 éƒ½ä¾èµ–äº† `axios@1.27.0`ï¼Œç»“æœä½ æŠŠ `node_modules/axios` æ‰“åŒ…å†…è”åˆ° dist é‡Œé¢ï¼Œé‚£ä¾èµ– pkg1 å’Œ pkg2 çš„ app è‚¯å®šä¼šå­˜åœ¨ä¸¤ä»½ axios ä»£ç å‘€ï¼Œ

### å£°æ˜ç‰ˆæœ¬å·ä½¿ç”¨å…¼å®¹æ€§å‰ç¼€

å£°æ˜ vue ç‰ˆæœ¬å·æœ‰ä¸¤ç§å¸¸è§æ–¹å¼ï¼š

1. å¸¦å…¼å®¹æ€§å‰ç¼€ï¼ˆæˆ–è€…è¯´é€šé…ç¬¦ï¼‰ `^2.7.14`
2. ä½¿ç”¨å›ºå®šç‰ˆæœ¬å· `2.7.14`ï¼Œç¡®å®æœ‰äººå–œæ¬¢è¿™ä¹ˆå¹²ï¼š[migrate tslint to eslint](https://github.com/nicoespeon/abracadabra/pull/459#discussion_r779566749)

é—®é¢˜åœºæ™¯ï¼š

é¡¹ç›®ä¸­çš„ workspace packages å£°æ˜äº† `vue@^2.6.10` å’Œ `vue@^2.7.14`ï¼Œä½¿ç”¨äº† pnpm-lock.yaml é”å®šç‰ˆæœ¬ï¼Œé¡¹ç›®ä¸­ä¹Ÿç¡®å®å®‰è£…äº†ä¸¤ä¸ªç‰ˆæœ¬ `vue2.6.10` å’Œ `vue2.7.14`ã€‚

åœ¨ä½¿ç”¨å…¼å®¹æ€§å‰ç¼€æ—¶ä¿®å¤æ–¹æ³•ï¼š

åˆ æ‰ `lockfile`, `node_modules`ï¼Œé‡æ–° `pnpm install`ï¼Œè¿™æ · pnpm åªä¼šå®‰è£… `vue@2.7.14`ã€‚

æ³¨æ„æˆ‘å‰é¢æåˆ°çš„è¦æ±‚ï¼š

1. åˆ é™¤ lockfileï¼Œå› ä¸º lockfile çš„ä½œç”¨å°±æ˜¯é”å®šç‰ˆæœ¬
2. åˆ é™¤ `node_modules`ï¼Œå› ä¸º pnpm è²Œä¼¼åœ¨ `node_modules` å­˜åœ¨æ—¶ï¼Œä¼šç›´æ¥å¤ç”¨å½“å‰ `node_modules` å®‰è£…çš„ä¾èµ–ç‰ˆæœ¬ä½œä¸ºè§£æçš„ç‰ˆæœ¬ï¼Œå…·ä½“çœ‹ issueï¼š[doesn't resolve to latest satisfied version](https://github.com/pnpm/pnpm/issues/7543)

è™½è¯´è¿™æ ·å¯ä»¥ä¿®å¤å®‰è£…å¤šä¸ªç‰ˆæœ¬çš„é—®é¢˜ï¼Œä½†æ˜¯åˆ é™¤ lockfile ä¼šå¯¼è‡´ä¾èµ–å‡çº§ï¼Œå¾€å¾€å¯èƒ½ä¼šå¼•å…¥æ–°çš„é—®é¢˜ï¼Œé¡¹ç›®è¶Šå¤§è¶Šå®¹æ˜“å‡ºé—®é¢˜ã€‚å¯èƒ½è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ pnpm åœ¨ v8 çš„æ—¶å€™å¯¹äºç›´æ¥ä¾èµ–é‡‡å– [lowest ç­–ç•¥](https://twitter.com/pnpmjs/status/1693707270897517022), è™½ç„¶åé¢æœ‰æ„è§çš„äººå¤ªå¤šåˆæ”¹å›å»äº†ã€‚

å°æŠ€å·§ï¼š

```bash
# monorepo é¡¹ç›®åˆ é™¤æ‰€æœ‰ node_modules
alias rmpkgs="rm -rf node_modules && pnpm -r exec rm -rf node_modules"
```

å…³äºé€šé…ç¬¦è¿™é‡Œå†æ’ä¸€å˜´ï¼Œä¸æ˜¯æ‰€æœ‰ç‰ˆæœ¬éƒ½é€‚åˆä½¿ç”¨ `^` å‰ç¼€ï¼Œåƒ `typescript` å»ºè®®ä½¿ç”¨ `~`ï¼Œ`typescript` æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¸éµå®ˆ `semver` ç‰ˆæœ¬å·çš„é¡¹ç›®ï¼Œ`minor` ç‰ˆæœ¬å·å˜åŒ–ä¹Ÿä¼šå¼•å…¥ç ´åæ€§å˜æ›´ã€‚

### ä½¿ç”¨ peerDependencies

ä¹‹å‰å‚ä¸å›¢é˜Ÿä¼šè®®çš„æ—¶å€™ï¼Œå¬åˆ°åŒäº‹æŠŠ `peerDependencies` ç¿»è¯‘ä¸º`å¯¹ç­‰ä¾èµ–`ï¼Œå¬çš„æˆ‘ç¨€é‡Œç³Šæ¶‚ï¼Œé—®äº†ä¸‹æ‰çŸ¥é“è¯´çš„æ˜¯ `peerDependencies`ï¼Œæˆ‘è§‰å¾—è¿™ç¿»è¯‘ç¡®å®ç¦»è°±ã€‚

å½“æˆ‘ä»¬ç»™æˆ‘ä»¬çš„ package æ·»åŠ ä¸€ä¸ªä¾èµ– dep æ—¶ï¼Œå¦‚æœå®‰è£…è¿™ä¸ª package çš„æ—¶å€™ï¼Œå¤§æ¦‚ç‡ dep å·²ç»è¢« app å®‰è£…äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å£°æ˜è¿™ä¸ª dep ä¸º peerDependenciesã€‚è¿™ç§ä¾èµ–å¾€å¾€æ˜¯æŸä¸ªç”Ÿæ€çš„æ ¸å¿ƒä¾èµ–ï¼Œä¾‹å¦‚ vue, react, @babel/core, type-fest, vite ç­‰ï¼Œä½¿ç”¨ peerDependencies æ˜¯æ—¶å€™ä¹Ÿå¾€å¾€æ˜¯æˆ‘ä»¬åœ¨å¼€å‘æ‰©å±•ï¼Œæˆ–è€…æŸä¸ªç”Ÿæ€ä¸‹çš„åº“ã€‚

å¦‚æœæˆ‘ä»¬å£°æ˜è¿™äº›ä¾èµ–ä¸º dependenciesï¼Œé‚£ä¹ˆç”±äºä¸åŒçš„ package å£°æ˜çš„ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œç”±äº lockfile çš„é”å®šä½œç”¨ï¼Œæœ‰å¯èƒ½å¯¼è‡´å®‰è£…å¤šä¸ªç‰ˆæœ¬ã€‚

å¦‚æœä½¿ç”¨ peerDependenciesï¼Œç”±äºæ‰€æœ‰çš„ packages ä¾èµ–çš„éƒ½æ˜¯ app å®‰è£…çš„ depï¼Œå°±ä¸ä¼šæœ‰é‡å¤ä¾èµ–çš„é—®é¢˜ã€‚

ä½†æ˜¯å®é™…æƒ…å†µå¾€å¾€æ›´å¤æ‚ï¼Œå‰é¢ä¹Ÿè¯´äº†ï¼Œ

### pnpm update -r

å¦‚æœé‡å¤å®‰è£…çš„ä¾èµ–æ˜¯ workspace packages çš„ç›´æ¥ä¾èµ–å¯¼è‡´çš„ï¼Œé€šè¿‡å‡çº§ä¾èµ–å¯ä»¥è§£å†³ã€‚

### pnpm dedupe

`pnpm update -r`ï¼Œå¯ä»¥è§£å†³ç›´æ¥ä¾èµ–é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½è§£å†³ä¾èµ–çš„ä¾èµ–æˆ–è€…è¯´é—´æ¥ä¾èµ–å¯¼è‡´çš„é—®é¢˜ã€‚

[pnpm dedupe](https://pnpm.io/cli/dedupe) æ˜¯ pnpm è‡ªå¸¦çš„ä¾èµ–å»é‡å‘½ä»¤ï¼Œæˆ‘åœ¨ä¸Šå®¶å…¬å¸çš„æ—¶å€™è¿™ä¸ªåŠŸèƒ½è¿˜æ²¡å‡ºã€‚

![pnpm dedupe](https://github.com/tjx666/astro-blog/blob/main/src/assets/images/å¦‚ä½•è§£å†³é¡¹ç›®ä¾èµ–é‡å¤æ‰“åŒ…é—®é¢˜/pnpm-dedupe.png?raw=true)

å¦‚æœåªæ˜¯æƒ³å¯¹é‡å¤ä¾èµ–åšæ£€æŸ¥è€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ lockfileï¼Œå¯ä»¥ä½¿ç”¨ `--check` å‚æ•°ï¼Œç”šè‡³å¯è€ƒè™‘ä»¥æŠŠè¿™ä¸€æ­¥åŠ åˆ° ci çš„ `pnpm install` ä¹‹å‰ã€‚ä½†æ˜¯æˆ‘æ„Ÿè§‰ä¸å¤ªå®ç”¨ï¼Œå› ä¸ºè¿™ä¼šæ£€æŸ¥åˆ°å¼€å‘ä¾èµ–ï¼Œå¼€å‘ä¾èµ–é‡å¤å…¶å®ä¸€èˆ¬æ˜¯ä¸å¤ª care çš„ã€‚

### é…ç½®æ‰“åŒ…å·¥å…·çš„ resolve

ä»¥ vite ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬ vue é¡¹ç›®éœ€è¦è¿è¡Œæ—¶ç¼–è¯‘æ¨¡ç‰ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€èˆ¬ä¼šè¿™ä¹ˆé…ç½®ï¼š

```typescript
export default defineConfig({
  resolve: {
    alias: {
      // æŒ‡å‘å¸¦æ¨¡ç‰ˆç¼–è¯‘å™¨çš„ç‰ˆæœ¬
      vue: 'node_modules/vue/dist/vue.esm-bundler.js',
    },
  },
});
```

å½“ app æ‰“åŒ…äº†ä¸€ä¸ªä¾èµ–å¤šä¸ªç‰ˆæœ¬æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è®©ä¸€ä¸ªåŒ…åæŒ‡å‘å”¯ä¸€çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼è¿˜å¯ä»¥å¤„ç†å­è·¯å¾„ï¼š

```typescript
export default defineConfig({
  resolve: {
    alias: [
      {
        // å½“æ—¶é¡¹ç›®ä» vue2.6 è¿ç§»åˆ° vue2.7
        find: '^vue$',
        replacement: 'node_modules/vue/dist/vue.esm-bundler.js',
      },
      {
        // å½“æ—¶æˆ‘ä»¬é¡¹ç›®ä¸­å­˜åœ¨ lodash å’Œ lodash-es æ··ç”¨çš„æƒ…å†µ
        find: /^lodash(\/.+)?/,
        replacement: 'lodash-es$1',
      },
    ],
  },
});
```

è¿™ç§æ–¹å¼çš„ç¼ºç‚¹ï¼š

1. ä¸€ä¸ªé¡¹ç›®å¯ä»¥å­˜åœ¨å¤šä¸ª appï¼Œä½ å¯èƒ½éœ€è¦å¤šä¸ªé¡¹ç›®å¤šæ¬¡é…ç½®ï¼Œå½“ç„¶æˆ‘ä»¬éƒ½ç”¨ monorepo äº†ï¼Œä¸€èˆ¬ä¼šæŠŠæ„å»ºé…ç½®å°è£…åˆ°ä¸€ä¸ª npm åŒ…ä¸­
2. å¯¹äºä¸€ä¸ªé‡å¤ä¾èµ–ï¼Œä½ éœ€è¦å®‰è£…åˆ° app çš„ node_modules ä¸­ï¼Œæ‰æ–¹ä¾¿ä½ åœ¨ alias ä¸­æŒ‡å‘å®ƒï¼Œæ¯”æ–¹è¯´æœ‰ä¸ªé‡å¤ä¾èµ– foo æ˜¯å¤šä¸ªé—´æ¥ä¾èµ–å¯¼è‡´çš„ï¼Œapp çš„ package.json æ²¡æœ‰ç›´æ¥ä¾èµ–åˆ° fooï¼Œä¸ºäº†é…ç½® resolve.aliasï¼Œä½ å¿…é¡»åœ¨ app çš„ package.json ä¸­å£°æ˜ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ç»´æŠ¤é¡¹ç›®çš„æ–°äººè§‰å¾—å¾ˆå›°æƒ‘ï¼Œæ˜æ˜ç”¨ä¸åˆ°çš„ä¾èµ–è¿˜è¦å®‰è£…ã€‚å¦‚æœæ˜¯ä½¿ç”¨ğŸ”ç‰ˆæœ¬çš„æ–¹å¼ï¼Œé‚£åªéœ€è¦åœ¨æ ¹ package.json ä¸­é…ç½®ä¸€æ¬¡ã€‚

### é”ç‰ˆæœ¬

`pnpm dedupe` å¯ä»¥åœ¨éµå®ˆå…¼å®¹æ€§å‰ç¼€çš„å‰æä¸‹æŠŠå¤šä¸ªç‰ˆæœ¬å‡åˆ°ä¸€ä¸ªæœ€é«˜çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯å¯¹äºåƒ 1.x, 2.x è¿™ç§ä¸ç¬¦åˆå…¼å®¹æ€§è¦æ±‚çš„æƒ…å†µå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚

è¿™ä¸¤å¹´ ESM å¤§è¡Œå…¶é“ï¼Œå¾ˆå¤šåŒ…å°±å› ä¸ºè¿ç§»åˆ° ESMï¼Œå°±å‘äº†å¤§ç‰ˆæœ¬ã€‚ç”±äºæˆ‘ä»¬é¡¹ç›®ä½¿ç”¨ vite è¿›è¡Œæ„å»ºï¼Œè¿™ç§æƒ…å†µå…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ 2.xã€‚

é™¤äº†å¤§ç‰ˆæœ¬è¿™ç§æƒ…å†µï¼Œè¿˜æœ‰æ”¹åŒ…åçš„æƒ…å†µï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­ `babel-runtime` å’Œ `@babel/runtime`ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å»é”å®šæ•´ä¸ªé¡¹ç›®ä¸­æŸä¸ªä¾èµ–çš„ç‰ˆæœ¬ï¼Œä¸åŒçš„åŒ…ç®¡ç†å™¨æ–¹æ³•ä¸å¤ªä¸€æ ·ï¼š

- [pnpm.overrides](https://pnpm.io/package_json#pnpmoverrides)
- [npm overrides](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#overrides)
- [yarn resolutions](https://classic.yarnpkg.com/en/docs/selective-version-resolutions)

```json
{
  "pnpm": {
    "overrides": {
      "vue": "2.7.14",
      "babel-runtime": "npm:`@babel/runtime7.24.3"
    }
  }
}
```

æˆ‘è¿˜åœ¨å›¢é˜Ÿçš„æ—¶å€™ï¼Œ `pnpm.overrides` æœ‰ä¸ª [bug](https://github.com/pnpm/pnpm/issues/4214)ï¼šä¸èƒ½é”å®š peerDependencies çš„ç‰ˆæœ¬ã€‚å½“æ—¶æ˜¯é€šè¿‡æ‰‹å†™ `.pnpmfile` é’©å­å»[è§£å†³](https://github.com/pnpm/pnpm/issues/4214#issuecomment-1578004504)è¿™ä¸ªé—®é¢˜çš„ï¼Œä¸è¿‡ç°åœ¨å·²ç»[ä¿®å¤](https://github.com/pnpm/pnpm/issues/6759)äº†ã€‚

è¿™é‡Œé¡ºä¾¿åˆ†äº«ä¸ªæ•…äº‹ï¼šæˆ‘è™½ç„¶æ˜¯åœ¨ç¼–è¾‘å™¨å›¢é˜Ÿï¼Œä½†æ˜¯å¾ˆå°‘å‚ä¸ç¼–è¾‘å™¨æœ¬èº«çš„åŠŸèƒ½è¿­ä»£ï¼Œæˆ‘è®°å¾—æ˜¯ 3 å¹´å‰ç¬¬ä¸€æ¬¡è·‘ç¼–è¾‘å™¨é¡¹ç›®çš„æ—¶å€™é‚£æ¬¡å®‰è£…ä¾èµ–è´¼è€—æ—¶ï¼Œå¼€äº†ä»£ç†ä¹Ÿæ²¡ç”¨ã€‚åŸå› æ˜¯é¡¹ç›®ä¸­ä¾èµ–äº† node-canvas, puppeteer ä¹‹ç±»åŒ…éœ€è¦ä¸‹è½½å¾ˆå¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯å®é™…ä¸Šé¡¹ç›®æ ¹æœ¬ç”¨ä¸åˆ°è¿™å‡ ä¸ªåŒ…ã€‚ä¸‰å¹´åæˆ‘å†æ¬¡å‚ä¸è¿™ä¸ªé¡¹ç›®çš„è¿­ä»£ï¼Œè¿˜æ˜¯è¿™ä¹ˆæ…¢ï¼Œæˆ‘å°±ç›´æ¥æˆªå¼ å›¾å‘ç¾¤é‡Œå¼€å–·äº†ã€‚æˆ‘çš„æ€§æ ¼å°±æ˜¯è¿™æ ·ï¼Œä¹‹å‰é¢è¯•çš„æ—¶å€™è¿˜è¢«é¢è¯•å®˜è¯´æˆ‘æœ‰ç‚¹å¼ºåŠ¿... å–·å½’å–·ï¼Œæˆ‘è¿˜æ˜¯æŠŠè¿™ä¸ªé—®é¢˜ç»™è§£å†³äº†ã€‚

é¦–å…ˆè¿™å‡ ä¸ªä¾èµ–æˆ‘ä»¬é¡¹ç›®é‡Œé¢ä¾èµ–åˆ°äº†ï¼Œä½†å®é™…ä¸Šæ˜¯ç”¨ä¸åˆ°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å½“æ—¶æ²¡æ³•æ¨åŠ¨åˆ«çš„å›¢é˜Ÿå»æŠŠé‚£å‡ ä¸ªä¸‹è½½è´¼æ…¢çš„ä¾èµ–ä» dependencies é‡Œé¢å¹²æ‰ã€‚å½“æ—¶æŸ¥é˜…èµ„æ–™å‘ç°äº†ï¼š[a way to ignore packages](https://github.com/yarnpkg/yarn/issues/4611#issuecomment-584903011)ï¼ŒåŸç†å°±æ˜¯æŠŠè¿™å‡ ä¸ªä¸éœ€è¦å®‰è£…çš„åŒ…é”å®šåˆ°ä¸€ä¸ªå ä½åŒ…ï¼š

```json
{
  "resolutions": {
    "node-canvas": "https://registry.yarnpkg.com/@favware/skip-dependency/-/skip-dependency-1.0.2.tgz"
  }
}
```

åé¢äº†è§£åˆ°æœ‰ `.pnpmfile.cjs` è¿™ä¸ªä¸œè¥¿æˆ‘å°±ç›´æ¥åœ¨é‚£é‡Œé¢å» delete æ‰é‚£å‡ ä¸ªä¾èµ–äº†ï¼Œä½†æ˜¯ `.pnpmfile.cjs` å…¶å®ä¹Ÿæœ‰ä¸ªæŒºæ— è¯­çš„ bugï¼š[.pnpmfile change not trigger resolution](https://github.com/pnpm/pnpm/issues/6726)ã€‚ä¸Šä¸ªæœˆæ‰ä¿®å¤çš„ã€‚

è¦ä¸æ˜¯å¤©å¤©å’Œ pnpm åšæ–—äº‰ï¼Œæˆ‘ä¹Ÿæƒ³ä¸åˆ°è¿™ç©æ„æœ‰è¿™ä¹ˆå¤š bugã€‚pnpm çºµç„¶æœ‰å¾ˆå¤š bugï¼ŒæŸäº›æ¡†æ¶å¦‚ electron å’Œ vsce å¯¹ pnpm è¿™ç§åŸºäºé“¾æ¥çš„åŒ…ç®¡ç†å™¨å…¼å®¹æ€§ä¸å¥½ã€‚ä½†æˆ‘è¿˜æ˜¯å¾ˆå–œæ¬¢ pnpmï¼Œå®‰è£…å¿«ï¼Œçœç©ºé—´ï¼Œnode_modules ä¸‹ç»“æ„æ¸…æ™°ï¼Œæä¾›äº†éå¸¸å¤šå®ç”¨çš„æ‰©å±•é€‰é¡¹ï¼Œè¿˜å¯ä»¥ç¼–å†™ `.pnpmfile.cjs` ä¿®æ”¹å®‰è£…é€»è¾‘ï¼Œç­‰ç­‰ã€‚

åœ¨ importmap ä¸­æœ‰ä¸ª `scope` å­—æ®µå…¶å®ä¹Ÿå¯ä»¥èµ·åˆ°é”å®šç‰ˆæœ¬çš„ä½œç”¨ï¼š

```json
{
  "imports": {
    "vue": "https://esm.dancf.com/npm:vue@2.7.14/dist/vue.esm.js"
  },
  "scopes": {
    "https://esm.dancf.com/": {
      "axios": "https://esm.dancf.com/npm:axios@1.3.5/dist/axios.min.js",
      "js-cookie": "https://esm.dancf.com/npm:js-cookie@3.0.1/dist/js.cookie.mjs",
      "uuid": "https://esm.dancf.com/npm:uuid@7.0.1/dist/esm-browser/index.js"
    }
  }
}
```

## åˆ†äº«ä¸€äº›æˆ‘åœ¨å’Œ pnpm åšæ–—äº‰æ—¶ä½¿ç”¨è¿‡çš„å·¥å…·

- [node_modules](https://marketplace.visualstudio.com/items?itemName=zyrong.node-modules) package.json æ¨¡å—è·³è½¬ï¼ŒåŒ…æœç´¢ç­‰ã€‚ç”±äºä½œè€…é•¿æœŸä¸ç»´æŠ¤ï¼Œæˆ‘å‡†å¤‡æŠŠä»£ç è¿ç§»åˆ° [Package Manager Enhancer](https://marketplace.visualstudio.com/items?itemName=YuTengjing.package-manager-enhancer)
- [Package Manager Enhancer](https://marketplace.visualstudio.com/items?itemName=YuTengjing.package-manager-enhancer) pnpm é…ç½®æç¤ºå’Œ package.json codelens
- [Version Lens](https://marketplace.visualstudio.com/items?itemName=pflannery.vscode-versionlens) å‡çº§ç‰ˆæœ¬ç”¨çš„ï¼Œå¦å¤–æ¨è antfu çš„ [taze](https://github.com/antfu/taze)
- [pnpm-lock-goto](https://marketplace.visualstudio.com/items?itemName=sooniter.pnpm-lock-goto) è§åçŸ¥æ„
- [bun.lockb](https://marketplace.visualstudio.com/items?itemName=jaaxxx.bun-lockb) bun çš„ lockfile æ˜¯äºŒè¿›åˆ¶çš„ï¼Œè¿™ä¸ªæ˜¯æŸ¥çœ‹å™¨
- [json-in-html](https://marketplace.visualstudio.com/items?itemName=andersonbruceb.json-in-html) importmap è¯­æ³•é«˜äº®
- [VSCode Archive](https://marketplace.visualstudio.com/items?itemName=YuTengjing.vscode-archive) è§£å‹ .tar.gz
- [open-related-website](https://chromewebstore.google.com/detail/open-related-website/kgpcgldebjnldkgfiecjogencpiadpml) æ–¹ä¾¿åœ¨ npm åŒ…çš„ github ä»“åº“æˆ–è€… npm ä¸»é¡µå¿«é€Ÿæ‰“å¼€åƒ [npm view](https://npmview.vercel.app/taze) ä¹‹ç±»çš„ç½‘ç«™

## å‚è€ƒèµ„æ–™

å†™ä½œè¿‡ç¨‹ä¸­ä¸»è¦å‚è€ƒäº†ä»¥ä¸‹èµ„æ–™ï¼š

- [pnpm å®˜æ–¹æ–‡æ¡£](https://pnpm.io/)
- [rsdoctor blog: é‡å¤ä¾èµ–é—®é¢˜](https://rsdoctor.dev/zh/blog/topic/duplicate-pkg-problem)

## æ€»ç»“

é¡¹ç›®ä¸­ä¸€ä¸ªåŒ…å®‰è£…å¤šä¸ªç‰ˆæœ¬å‡ ä¹æ˜¯ä¸å¯é¿å…çš„ï¼Œåˆç†ä½¿ç”¨ç‰ˆæœ¬å…¼å®¹æ€§å‰ç¼€å’Œ peerDependencies å¯ä»¥ä¸€å®šç¨‹åº¦ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚

åˆ†æé‡å¤æ‰“åŒ…çš„æºç ä¾èµ–å»ºè®®ä½¿ç”¨æ’ä»¶ï¼š[unplugin-detect-duplicated-deps](https://github.com/tjx666/unplugin-detect-duplicated-deps)ï¼Œ[rsdoctor](https://rsdoctor.dev/zh/) ä¹Ÿä¸é”™ï¼Œä¸è¿‡å®ƒåªæ”¯æŒ webpack å’Œ rspackã€‚

ä¿®å¤é‡å¤æ‰“åŒ…ä¾èµ–ï¼Œä¸€èˆ¬æƒ…å†µå¯ä»¥é€šè¿‡ `pnpm update` + `pnpm dedupe` æ¥è‡ªåŠ¨ä¿®å¤ï¼Œå¯¹äºè·¨å¤§ç‰ˆæœ¬ï¼Œæ¢åŒ…åï¼Œæˆ–è€…å…¶å®ƒå¾ˆéš¾è§£å†³çš„æƒ…å†µå»ºè®®ç›´æ¥ä¸Š `pnpm.overrides` é”å®šç‰ˆæœ¬ã€‚

å»ºè®®å¼€å¯ [unplugin-detect-duplicated-deps](https://github.com/tjx666/unplugin-detect-duplicated-deps) çš„ `throwErrorWhenDuplicated` é€‰é¡¹å°†å…¶ä½œä¸º ci check æ¥é¢„é˜²å†æ¬¡å‡ºç°ä¾èµ–é‡å¤æ‰“åŒ…ã€‚
